<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¹´é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>

    <style>
        /* CSS */
        body { font-family: sans-serif; margin: 0; padding: 20px 20px 80px 20px; background-color: #f4f4f9; color: #333; }
        .screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80vh; text-align: center; }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        h1 { margin: 0; color: #1a1a1a; font-size: 1.5em; }
        h2 { margin: 5px 0 0; color: #555; font-weight: normal; font-size: 1.1em; }
        h3 { color: #007bff; border-bottom: 1px solid #007bff; padding-bottom: 5px; font-size: 1.2em; }
        section { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #fafafa; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #333; color: white; text-align: center; padding: 10px 0; font-size: 0.9em; z-index: 100; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen" class="screen">
        <div class="spinner"></div>
        <p>ã‚¢ãƒ—ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <div id="error-screen" class="screen hidden">
        <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
        <p id="error-message"></p>
        <button onclick="location.reload()">å†è©¦è¡Œ</button>
    </div>

    <div id="main-content" class="hidden">
        <header>
            <h1 id="main-title"></h1>
            <h2 id="sub-title"></h2>
        </header>
        <section>
            <h3>å¹´é–“è¨ˆç”»</h3>
            <div id="schedule-container" class="table-container">
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
        </section>
        <section>
            <h3>é€£çµ¡äº‹é …</h3>
            <div id="board-container" class="table-container">
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
        </section>
    </div>
    
    <footer id="footer-status">
        <span id="status-icon"></span> <span id="status-text">æº–å‚™ä¸­...</span>
    </footer>

    <script>
        // --- ã“ã“ã‹ã‚‰JavaScript ---

        // 1. è¨­å®š
        const CONFIG = {
            // â˜…ã”è‡ªèº«ã®LIFF IDã«æ›¸ãæ›ãˆã¦ãã ã•ã„
            liffId: "2007511020-EQ98my1W", 
            // â˜…ã”è‡ªèº«ã®GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
            apiUrl: "https://script.google.com/macros/s/AKfycbxV4BWni-PkoDuT0fpun7oR4UplzuA2rcLHqfPPeNDKz0u4ZN_rWVlXt2jUe3XTPyirOw/exec",
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨vConsoleã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
            debug: true,
        };

        // 2. UIæ“ä½œã‚¯ãƒ©ã‚¹
        class UIManager {
            constructor() {
                this.elements = {
                    loading: document.getElementById('loading-screen'),
                    error: document.getElementById('error-screen'),
                    main: document.getElementById('main-content'),
                    errorMessage: document.getElementById('error-message'),
                    mainTitle: document.getElementById('main-title'),
                    subTitle: document.getElementById('sub-title'),
                    scheduleContainer: document.getElementById('schedule-container'),
                    boardContainer: document.getElementById('board-container'),
                    statusIcon: document.getElementById('status-icon'),
                    statusText: document.getElementById('status-text'),
                };
            }

            show(screenName) {
                ['loading', 'error', 'main'].forEach(name => {
                    this.elements[name].classList.toggle('hidden', name !== screenName);
                });
            }

            renderError(message) {
                this.elements.errorMessage.textContent = message;
                this.show('error');
            }
            
            renderData(data) {
                this.elements.mainTitle.textContent = data.mainTitle || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
                this.elements.subTitle.textContent = data.subTitle || '';
                this._renderTable(this.elements.scheduleContainer, data.scheduleData, 'å¹´é–“è¨ˆç”»');
                this._renderTable(this.elements.boardContainer, data.boardData, 'é€£çµ¡äº‹é …');
            }

            _renderTable(container, data, defaultMessage) {
                if (!data || data.length <= 1 || data.slice(1).every(row => row.every(cell => !cell))) {
                    container.innerHTML = `<p>${defaultMessage}ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                    return;
                }
                const table = document.createElement('table');
                const thead = table.createTHead();
                const tbody = table.createTBody();

                // ãƒ˜ãƒƒãƒ€ãƒ¼
                const headerRow = thead.insertRow();
                data[0].forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                // ãƒœãƒ‡ã‚£
                data.slice(1).forEach(rowData => {
                    if (rowData.every(cell => cell === '')) return; // ç©ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                    const row = tbody.insertRow();
                    rowData.forEach(cellData => {
                        const cell = row.insertCell();
                        cell.textContent = cellData;
                    });
                });
                container.innerHTML = '';
                container.appendChild(table);
            }

            setStatus(icon, text) {
                this.elements.statusIcon.textContent = icon;
                this.elements.statusText.textContent = text;
            }
        }

        // 3. APIé€šä¿¡ã‚¯ãƒ©ã‚¹
        class ApiClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
            }

            async _fetch(endpoint, options = {}) {
                try {
                    const response = await fetch(this.baseUrl + endpoint, options);
                    if (!response.ok) {
                        throw new Error(`APIã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${response.status})`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${data.error}`);
                    }
                    return data;
                } catch (error) {
                    console.error('APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            getPageData() {
                return this._fetch('?action=getPageData');
            }

            saveUser(idToken) {
                const options = {
                    method: 'POST',
                    mode: 'cors', // CORSãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveUser', idToken: idToken })
                };
                return this._fetch('', options); // POSTã®å ´åˆã€endpointã¯ç©º
            }
        }

        // 4. ãƒ¡ã‚¤ãƒ³å‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            const ui = new UIManager();
            const api = new ApiClient(CONFIG.apiUrl);

            if (CONFIG.debug) {
                try {
                    window.vConsole = new VConsole();
                } catch(e) {
                    console.error("vConsoleã®åˆæœŸåŒ–ã«å¤±æ•—", e);
                }
            }

            try {
                ui.setStatus('ğŸ”„', 'LIFFã‚’åˆæœŸåŒ–ä¸­...');
                await liff.init({ liffId: CONFIG.liffId });

                if (!liff.isLoggedIn()) {
                    ui.setStatus('ğŸ”', 'LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                    liff.login({ redirectUri: location.href }); // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                    return;
                }

                ui.setStatus('ğŸ‘¤', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ä¸­...');
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ä¸¦è¡Œã—ã¦å®Ÿè¡Œã—ã€é«˜é€ŸåŒ–
                const saveUserPromise = api.saveUser(idToken);
                const getDataPromise = api.getPageData();

                const [saveResult, pageData] = await Promise.all([saveUserPromise, getDataPromise]);
                
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜çµæœ:', saveResult);
                ui.renderData(pageData);
                ui.show('main');
                ui.setStatus('âœ…', `ã‚ˆã†ã“ãã€${saveResult.displayName} ã•ã‚“`);

            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                ui.renderError(error.message);
                ui.setStatus('âŒ', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        });
    </script>
</body>
</html>
