<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>年間スケジュール</title>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>

    <style>
        /* CSS */
        body { font-family: sans-serif; margin: 0; padding: 20px 20px 80px 20px; background-color: #f4f4f9; color: #333; }
        .screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80vh; text-align: center; }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        h1 { margin: 0; color: #1a1a1a; font-size: 1.5em; }
        h2 { margin: 5px 0 0; color: #555; font-weight: normal; font-size: 1.1em; }
        h3 { color: #007bff; border-bottom: 1px solid #007bff; padding-bottom: 5px; font-size: 1.2em; }
        section { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #fafafa; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #333; color: white; text-align: center; padding: 10px 0; font-size: 0.9em; z-index: 100; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen" class="screen">
        <div class="spinner"></div>
        <p>アプリを読み込んでいます...</p>
    </div>

    <div id="error-screen" class="screen hidden">
        <h2>エラーが発生しました</h2>
        <p id="error-message"></p>
        <button onclick="location.reload()">再試行</button>
    </div>

    <div id="main-content" class="hidden">
        <header>
            <h1 id="main-title"></h1>
            <h2 id="sub-title"></h2>
        </header>
        <section>
            <h3>年間計画</h3>
            <div id="schedule-container" class="table-container">
                <p>データを読み込んでいます...</p>
            </div>
        </section>
        <section>
            <h3>連絡事項</h3>
            <div id="board-container" class="table-container">
                <p>データを読み込んでいます...</p>
            </div>
        </section>
    </div>
    
    <footer id="footer-status">
        <span id="status-icon"></span> <span id="status-text">準備中...</span>
    </footer>

    <script>
        // --- ここからJavaScript ---

        // 1. 設定
        const CONFIG = {
            // ★ご自身のLIFF IDに書き換えてください
            liffId: "2007511020-EQ98my1W", 
            // ★ご自身のGASウェブアプリURLに書き換えてください
            apiUrl: "https://script.google.com/macros/s/AKfycbxV4BWni-PkoDuT0fpun7oR4UplzuA2rcLHqfPPeNDKz0u4ZN_rWVlXt2jUe3XTPyirOw/exec",
            
            // デバッグ用vConsoleを表示するかどうか
            debug: true,
        };

        // 2. UI操作クラス
        class UIManager {
            constructor() {
                this.elements = {
                    loading: document.getElementById('loading-screen'),
                    error: document.getElementById('error-screen'),
                    main: document.getElementById('main-content'),
                    errorMessage: document.getElementById('error-message'),
                    mainTitle: document.getElementById('main-title'),
                    subTitle: document.getElementById('sub-title'),
                    scheduleContainer: document.getElementById('schedule-container'),
                    boardContainer: document.getElementById('board-container'),
                    statusIcon: document.getElementById('status-icon'),
                    statusText: document.getElementById('status-text'),
                };
            }

            show(screenName) {
                ['loading', 'error', 'main'].forEach(name => {
                    this.elements[name].classList.toggle('hidden', name !== screenName);
                });
            }

            renderError(message) {
                this.elements.errorMessage.textContent = message;
                this.show('error');
            }
            
            renderData(data) {
                this.elements.mainTitle.textContent = data.mainTitle || 'タイトルなし';
                this.elements.subTitle.textContent = data.subTitle || '';
                this._renderTable(this.elements.scheduleContainer, data.scheduleData, '年間計画');
                this._renderTable(this.elements.boardContainer, data.boardData, '連絡事項');
            }

            _renderTable(container, data, defaultMessage) {
                if (!data || data.length <= 1 || data.slice(1).every(row => row.every(cell => !cell))) {
                    container.innerHTML = `<p>${defaultMessage}はありません。</p>`;
                    return;
                }
                const table = document.createElement('table');
                const thead = table.createTHead();
                const tbody = table.createTBody();

                // ヘッダー
                const headerRow = thead.insertRow();
                data[0].forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                // ボディ
                data.slice(1).forEach(rowData => {
                    if (rowData.every(cell => cell === '')) return; // 空行はスキップ
                    const row = tbody.insertRow();
                    rowData.forEach(cellData => {
                        const cell = row.insertCell();
                        cell.textContent = cellData;
                    });
                });
                container.innerHTML = '';
                container.appendChild(table);
            }

            setStatus(icon, text) {
                this.elements.statusIcon.textContent = icon;
                this.elements.statusText.textContent = text;
            }
        }

        // 3. API通信クラス
        class ApiClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
            }

            async _fetch(endpoint, options = {}) {
                try {
                    const response = await fetch(this.baseUrl + endpoint, options);
                    if (!response.ok) {
                        throw new Error(`APIサーバーとの通信に失敗しました (HTTP ${response.status})`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(`APIエラー: ${data.error}`);
                    }
                    return data;
                } catch (error) {
                    console.error('API通信エラー:', error);
                    throw error;
                }
            }

            getPageData() {
                return this._fetch('?action=getPageData');
            }

            saveUser(idToken) {
                const options = {
                    method: 'POST',
                    mode: 'cors', // CORSリクエストを許可
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveUser', idToken: idToken })
                };
                return this._fetch('', options); // POSTの場合、endpointは空
            }
        }

        // 4. メイン処理
        document.addEventListener('DOMContentLoaded', async () => {
            const ui = new UIManager();
            const api = new ApiClient(CONFIG.apiUrl);

            if (CONFIG.debug) {
                try {
                    window.vConsole = new VConsole();
                } catch(e) {
                    console.error("vConsoleの初期化に失敗", e);
                }
            }

            try {
                ui.setStatus('🔄', 'LIFFを初期化中...');
                await liff.init({ liffId: CONFIG.liffId });

                if (!liff.isLoggedIn()) {
                    ui.setStatus('🔐', 'LINEログインが必要です。リダイレクトします...');
                    liff.login({ redirectUri: location.href }); // ログイン後、このページに戻る
                    return;
                }

                ui.setStatus('👤', 'ユーザー情報を保存中...');
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error('ユーザーIDトークンを取得できませんでした。');
                }

                // ユーザー保存とデータ取得を並行して実行し、高速化
                const saveUserPromise = api.saveUser(idToken);
                const getDataPromise = api.getPageData();

                const [saveResult, pageData] = await Promise.all([saveUserPromise, getDataPromise]);
                
                console.log('ユーザー保存結果:', saveResult);
                ui.renderData(pageData);
                ui.show('main');
                ui.setStatus('✅', `ようこそ、${saveResult.displayName} さん`);

            } catch (error) {
                console.error('アプリケーションの初期化中にエラーが発生しました:', error);
                ui.renderError(error.message);
                ui.setStatus('❌', 'エラーが発生しました');
            }
        });
    </script>
</body>
</html>
